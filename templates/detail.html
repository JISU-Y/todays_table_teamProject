<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"
    ></script>

    <!-- 구글폰트 -->
    <link
            href="https://fonts.googleapis.com/css?family=Stylish&display=swap"
            rel="stylesheet"
    />

    <script src="/static/scripts/dtail.js"></script>
    <link rel="stylesheet" href="/static/styles/detail.css"/>
    <link rel="stylesheet" href="/static/styles/reset.css"/>

    <title>details</title>

    <script>
        $(document).ready(function () {
            get_comments("{{ food.no }}")
        })

        function save_comment() {
            let comment = $('.input-comment').val()
            let num = "{{ food.no }}"
            let today = new Date().toISOString()
            $.ajax({
                type: 'POST',
                url: '/api/save_comment',
                data: {
                    comment_give: comment,
                    num_give: num,
                    time_give: today
                },
                success: function (response) {
                    alert(response["msg"])
                    window.location.reload()
                }
            })
        }

        function delete_comment(username, comment) {
            $.ajax({
                type: "POST",
                url: '/api/delete_comment',
                data: {
                    username_give: username,
                    comment_give: comment
                },
                success: function (response) {
                    alert(response["msg"])
                    window.location.reload()
                }
            });
        }


        function time2str(date) {
            let today = new Date()
            let time_ex = today - date
            let time = time_ex / 1000 / 60 // 분

            if (time < 2) {
                return "방금 전"
            }

            if (time < 60) {
                return parseInt(time) + "분 전"
            }
            time = time / 60 // 시간
            if (time < 24) {
                return parseInt(time) + "시간 전"
            }
            time = time / 24 // 일
            if (time < 7) {
                return parseInt(time) + "일 전"
            }
            return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`
        }

        function get_comments(food_num) {
            $.ajax({
                type: "POST",
                url: "/api/get_comments",
                data: {
                    "num_give": food_num
                },
                success: function (response) {
                    if (response["result"] == "success") {
                        let comments = response["comments"]
                        for (let i = 0; i < comments.length; i++) {
                            let comment = comments[i]
                            if (comment["num"] == food_num) {
                                let time_post = new Date(comment["time"])
                                let time_before = time2str(time_post)
                                let html_temp = `<div class="comment">
                                                    <div class="user">
                                                        <img class="user-profil" src="https://picsum.photos/id/237/200/300" alt="유저 프로필사진">
                                                        <p class="user-name"> ${comment["username"]}</p>
                                                    </div>
                                                    <p class="comment-text">
                                                        ${comment["comment"]}
                                                    </p>
                                                    <div class="comment-bottom">
                                                        <span class="date">${time_before}</span>
                                                        <button class="delete-btn" onclick="delete_comment('${comment["username"]}','${comment["comment"]}')">삭제</button>
                                                    </div>
                                                </div>`
                                $('#comments').append(html_temp)
                            }
                        }
                    }
                }
            })
        }
    </script>


</head>
<body>
<div class="wrap">
    <section id="comments">
        <form action="" class="form-comment">
            <input class="input-comment" type="text" placeholder="댓글 입력">
            <button type="submit" onclick=save_comment()>입력</button>
        </form>


    </section>
</div>
</body>
</html>
