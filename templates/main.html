<!DOCTYPE html>
<html lang="ko">
  <head>

    <title>오늘의 식탁</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta charset="UTF-8" />
    <meta property="og:site_name" content="오늘의 식탁" />
    <meta property="og:title" content="마이페이지" />
    <meta property="og:image" content="" />
    <meta property="og:description" content="" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content="ko_KR" />
    <meta property="og:type" content="website" />

    <!-- 구글폰트 -->
    <link href="https://fonts.googleapis.com/css?family=Stylish&display=swap" rel="stylesheet"/>
    
    <!-- css -->
    <link rel="stylesheet" href="/static/styles/main.css"/>
    <link rel="stylesheet" href="/static/styles/reset.css"/>
    <link rel="stylesheet" href="/static/styles/common.css"/>
    <link rel="icon" href="../static/imgs/favicon.ico"/>
    
    <!-- font awesome 추가 -->
    <script src="https://kit.fontawesome.com/28653e43c1.js" crossorigin="anonymous"></script>

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"></script>
    <script defer src="../static/scripts/common.js"></script>

</head>
<body>
<header id="header">
  <h1>
    <a onclick="window.location.href='/'">
      <img class="logo" src="../static/imgs/logo.PNG" alt="오늘 뭐먹지?"/>
    </a>
  </h1>
  <div tabindex="0" class="user">
    <span class="user-name"><span class="user-name-db">{{ nickname }} </span>님</span>
    <img src="../static/{{ user_pic }}" alt="프로필"/>
    <div class="nav">
      <div onclick="userpage()">마이페이지</div>
      <div onclick="sign_out()">로그아웃</div>
    </div>
  </div>
</header>
<button id="top-btn" type="button">Top</button>
<div class="main-container">
  <div class="recommend-container">
    <h2>추천 드려요~!</h2>
    <h4>오늘의 건강식을 추천드립니다. 확인해보세요!</h4>
    <div class="image-container">
      {% for dish in recommends %}
      <div class="dish">
        <a href="/detail/{{ dish.no }}">
          <img src="{{ dish.img }}" alt="dish-image" />
          <div class="dish-desc">
            <p class="dish-name">{{ dish.menu_name }}</p>
            <p class="dish-type">{{ dish.menu_type }}</p>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
    <button class="recommend-btn" onclick="show_modal()">
      마음에 드는 게 없다면?
    </button>
  </div>
    <div class="list-container">
      <h2>건강한 레시피를 찾아보세요!</h2>
      <h4>원하시는 재료를 검색해서 건강한 음식을 찾아보세요!</h4>
      <form class="search-form">
        <input
          type="text"
          class="search-input"
          id="input"
          placeholder="재료 입력"/>
        <button type="submit" class="search-btn">찾기</button>
      </form>
      <div class="dish-lists" id="ds">
        {% for dish in dishes %} {% set class_heart = "" %} {% if
        dish["like_by_me"] %} {% set class_heart = "fa-heart" %} {% else %} {%
        set class_heart = "fa-heart-o" %} {% endif %}
        <div id="{{ dish.no }}" class="dish">
          <a href="/detail/{{ dish.no }}">
            <div class="img-wrap">
              <img src="{{ dish.img }}" alt="dish-image" />
            </div>
            <div class="description">
              <p class="dish-type">{{ dish.menu_type }}</p>
              <h3 class="dish-name">{{ dish.menu_name }}</h3>
            </div>
          </a>
          <a
            class="level-item"
            aria-label="heart"
            onclick="toggle_like('{{ dish.no }}', 'heart')">
            <i class="fa {{ class_heart }}" aria-hidden="true"></i>
            <span class="like-num">{{ dish.count_like }}</span>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- 모달 -->
    <div class="modal hidden">
      <div class="modal-contents">
        <div class="modal-wrap">
          <h1>질문에 답해주세요.</h1>
          <div class="question-wrap">
            <div class="questions-container">
              <h3 class="question">Q1. 밥 vs 디저트</h3>
              <label class="box-radio-input">
                <input
                  type="radio"
                  name="item_type"
                  value="밥"
                  checked="checked"/>
                  <span>밥</span>
                </label>
              <label class="box-radio-input">
                <input 
                  type="radio" 
                  name="item_type" 
                  value="후식" />
                <span>후식</span>
              </label>
            </div>
            <div class="questions-container">
              <h3 class="question">Q2. 고단백 vs 저염식</h3>
              <label class="box-radio-input">
                <input 
                  type="radio" 
                  name="item_healthy" 
                  value="저염"
                  checked="checked"/>
                  <span>저염</span>
                </label>
              <label class="box-radio-input">
                <input type="radio" name="item_healthy" value="고단백"/>
                  <span>고단백</span>
                </label>
            </div>
            <div class="questions-container">
              <h3 class="question">Q3. 다이어트식 vs 보양식</h3>
              <label class="box-radio-input">
                <input
                  type="radio"
                  name="item_cal"
                  value="다이어트식"
                  checked="checked"/>
                  <span>다이어트식</span>
              </label>
              <label class="box-radio-input"><input type="radio" name="item_cal" value="보양식" />
                <span>보양식</span>
              </label>
            </div>
          </div>
          <div class="control-container">
            <button class="prev" id="prev" disabled>prev</button>
            <button class="next" id="next">next</button>
            <button class="submit hide" id="submit">submit</button>
          </div>
        </div>

        <!-- 메뉴추천 -->
        <div class="modal-result">
          <h1>추천 드립니다!</h1>
          <div class="recomended-dish">
            <button class="retry-btn">다시 추천 받기</button>
          </div>
        </div>
        <button class="exit-btn" onclick="hide_modal()">X</button>
      </div>
    </div>
  <footer id="footer">© 2021 오늘뭐먹지? by 5조</footer>
</div>
</body>
  <script src="/static/scripts/main.js"></script>
  <script>
    
    let idx = 0;

    const modalContents = document.querySelector(".modal-contents");
    const modalWrap = document.querySelector(".modal-wrap");
    const modalResult = document.querySelector(".modal-result");
    const controlContainer = document.querySelector(".control-container");
    const questionWrap = document.querySelector(".question-wrap");
    const questions = document.querySelectorAll(".questions-container");
    const prevBtn = document.querySelector(".prev");
    const nextBtn = document.querySelector(".next");
    const submitBtn = document.querySelector(".submit");
    const modalHideBtn = document.querySelector(".exit-btn");

    controlContainer.addEventListener("click", (e) => {
      if (e.target.id === "prev") {
        idx--;
        moveQuestion();
      } else if (e.target.id === "next") {
        idx++;
        moveQuestion();
      }
    });

    function moveQuestion() {
        prevBtn.disabled = false

        if (idx === questions.length - 1) {
            console.log('마지막 질문')
            nextBtn.classList.add('hide')
            submitBtn.classList.remove('hide')
            idx = questions.length - 1
        } else if (idx < 0) {
            idx = 0
        } else if (idx === 0) {
            prevBtn.disabled = true
        } else {
            nextBtn.classList.remove('hide')
            submitBtn.classList.add('hide')
        }
        questionWrap.style.transform = `translateX(${-idx * 900}px) translateY(-50%)`;
    }

    function clearQnA() {
      // 설문 clear
      prevBtn.disabled = true;

      idx = 0;
      questionWrap.style.transform = `translateX(0) translateY(-50%)`;
      nextBtn.classList.remove("hide");
      submitBtn.classList.add("hide");

      document.querySelector('input[value="밥"]').checked = true;
      document.querySelector('input[value="저염"]').checked = true;
      document.querySelector('input[value="다이어트식"]').checked = true;
    }

    function retryQnA() {
      clearQnA();

      modalWrap.style.display = "flex";
      modalResult.style.display = "none";
    }

    submitBtn.addEventListener("click", (e) => {
      const answerType = document.querySelector(
        'input[name="item_type"]:checked'
      ).value;
      const answerHowto = document.querySelector(
        'input[name="item_healthy"]:checked'
      ).value;
      const answerCal = document.querySelector(
        'input[name="item_cal"]:checked'
      ).value;

      const answers = [answerType, answerHowto, answerCal];
      console.log(answers);

      // 질문지는 감추고 결과는 보여주고
      modalWrap.style.display = "none";
      modalResult.style.display = "flex";
      clearQnA();

      $(".recomended-dish").find(":not(button)").remove();
      // 메뉴 한 개 추천받으러
      $.ajax({
        type: "POST",
        url: "/api/recommend_food",
        data: {
          answers1: answerType,
          answers2: answerHowto,
          answers3: answerCal,
        },
        success: function (response) {
          if (response["result"] == "success") {
            let recommended_dish = response["recommended"][0];
            let temp_html = `<a href="/detail/${recommended_dish["no"]}" id="result-dish">
                              <h3 class="dish-name"> ${recommended_dish["menu_name"]}</h3>
                                    <div class="img-wrap">
                                      <img src="${recommended_dish["img"]}" alt="dish-image" />
                                    </div>
                                    <div class="description">
                                      <p class="dish-type">${recommended_dish["menu_type"]}류</p>
                                      <p class="dish-howto">${recommended_dish["menu_howto"]}</p>
                                      <p class="dish-cal">${recommended_dish["calorie"]}kcal</p>
                                      <p class="dish-car">탄: ${recommended_dish["carbo"]}g</p>
                                      <p class="dish-protein">단: ${recommended_dish["protein"]}g</p>
                                      <p class="dish-fat">지: ${recommended_dish["fat"]}g</p>
                                      <p class="dish-natrium">염: ${recommended_dish["natrium"]}mg</p>
                                    </div>
                                  </a>`;
            $(".recomended-dish").prepend(temp_html);
          }
        },
        error: function (e) {
          console.log(e);
          // 추천할 것이 없어서 오류났을 때
          let temp_html = `<p class="retry-noti">
                선택하신 카테고리에 맞는 음식이 없어요ㅠㅠ
              </p>
          `;

          $(".recomended-dish").prepend(temp_html);
        },
      });
    });

    const retryBtn = document.querySelector(".retry-btn");
    retryBtn.addEventListener("click", (e) => {
      retryQnA();
    });

    modalHideBtn.addEventListener("click", (e) => {
      retryQnA();
    });

    let dishes = {{ dishes|tojson }}; //dish
    $(document).ready(function () {
        $(".search-form").on("submit", function (e) {
            e.preventDefault();
            let words = $(".search-input").val();
            $(".search-input").val("");
            $('#ds').empty();
            let existWords = false;
            for (let i = 0; i < dishes.length; i++) {
                if (dishes[i]["ingredient"].includes(words)) {
                    let dish = dishes[i]
                    let class_heart = dish["like_by_me"] ? "fa-heart" : "fa-heart-o";
                    let dish_no = dishes[i]['no'];
                    let dish_img = dishes[i]['img'];
                    let dish_name = dishes[i]["menu_name"];
                    let dish_type = dishes[i]["menu_type"];
                    let temp_html =
                        `<div id = "${dish.no}" class="dish">
                         <a href="/detail/${dish_no}">
                         <div class="img-wrap">
                         <img src="${dish_img}" alt="dish-image"/>
                         </div>
                         <div class="description">
                         <p class="dish-type">${dish_type}</p>
                         <h3 class="dish-name">${dish_name}</h3>

                         </div></a>
                         <a
                         class="level-item"
                         aria-label="heart"
                         onclick="toggle_like('${dish_no}', 'heart')">
                         <i class= "fa ${class_heart}" aria-hidden="true"></i>
                          <span class="like-num"> ${dish["count_like"]}</span></a>
                         </div>`
                    $('#ds').append(temp_html);
                    existWords = true;
                }
            }
            if (existWords == false || words == "") {
                alert("다른 재료를 입력해주세요!");
            }
        });
    });

    
  </script>
</html>
